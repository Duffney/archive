{
  "$type": "Octopus.Core.Model.Projects.CommunityActionTemplate, Octopus.Core",
  "Id": "CommunityActionTemplates-166",
  "Name": "Rackspace - Update Load Balancer",
  "ExternalId": "94aa35a3-0a0c-4c45-8781-98006bda3bcd",
  "Description": "Change the condition of a node in a Rackspace Cloud Load Balancer.",
  "Version": 3,
  "ActionType": "Octopus.Script",
  "Author": "sportingsolutions",
  "Website": "https://library.octopus.com/step-templates/94aa35a3-0a0c-4c45-8781-98006bda3bcd",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates/rackspace-update-load-balancer.json",
  "Category": "Rackspace",
  "Properties": {
    "Octopus.Action.Script.ScriptBody": "$username = $OctopusParameters['Username']\n$apiKey = $OctopusParameters['ApiKey']\n$loadbalanderId = $OctopusParameters['LoadBalancerID']\n$newNodeCondition = $OctopusParameters['NewCondition']\n$ipAddress = $OctopusParameters['NodeIpAddress']\n\nif ($newNodeCondition -ne \"ENABLED\" -and $newNodeCondition -ne \"DISABLED\" -and $newNodeCondition -ne \"DRAINING\")\n{\n    throw \"Condition must be one of 'ENABLED', 'DISABLED' or 'DRAINING'\"\n}\n\n# Get token and manipulation URL\n\n$tokensUri = \"https://lon.identity.api.rackspacecloud.com/v2.0/tokens\"\n$tokensBody = @\"\n{\n    \"auth\":\n    {\n       \"RAX-KSKEY:apiKeyCredentials\":\n       {  \n          \"username\": \"$username\",  \n          \"apiKey\": \"$apiKey\"\n       }\n    }  \n}\n\"@\n\nWrite-Host \"Sending request $tokensBody to $tokensUri\"\n\n$tokensResponse = Invoke-WebRequest -Uri $tokensUri -Method Post -Body $tokensBody -ContentType \"application/json\" -UseBasicParsing\n\nif ($tokensResponse.StatusCode -ne 200)\n{\n    throw \"Authorisation failed\"\n}\n\n$tokensObj = ConvertFrom-Json -InputObject $tokensResponse.Content\n\n$loadBalancerDetails = $tokensObj.access.serviceCatalog | Where {$_.name -eq \"cloudLoadBalancers\"}\n$endpoints = $loadBalancerDetails.endpoints | Select -First 1\n$loadbalancerUrl = $endpoints.publicURL\n$token = $tokensObj.access.token.id\n\n# Update node\n\n$header = @{}\n$header.Add(\"X-Auth-Token\", $token)\n$nodesUrl = \"$loadbalancerUrl/loadbalancers/$loadbalancerId/nodes\"\n\nWrite-Host \"Getting node details from $nodesUrl\"\n\n$nodesResponse = Invoke-WebRequest -Uri $nodesUrl -Method Get -Headers $header -ContentType \"application/json\" -UseBasicParsing\n\nif ($nodesResponse.StatusCode -ne 200)\n{\n    throw \"Getting load balancer details failed\"\n}\n\n$nodesObj = ConvertFrom-Json -InputObject $nodesResponse.Content\n$node = $nodesObj.nodes | Where {$_.address -eq $ipAddress}\n$nodeId = $node.id\n\n$updateBody = @\"\n{\n    \"node\": {\n        \"condition\" : \"$newNodeCondition\"\n    }\n}\n\"@\n$updateUrl = \"$loadbalancerUrl/loadbalancers/$loadbalancerId/nodes/$nodeId\"\n\nWrite-Host \"Updating node $nodeId to $newNodeCondition\"\nWrite-Host \"$updateBody\"\nWrite-Host \"$updateUrl\"\n\n$updateResponse = Invoke-WebRequest -Uri $updateUrl -Body $updateBody -Method Put -Headers $header -ContentType \"application/json\" -UseBasicParsing\n\nif ($updateResponse.StatusCode -ne 202)\n{\n    throw \"Updating load balancer failed\"\n}",
    "Octopus.Action.Script.Syntax": "PowerShell"
  },
  "Parameters": [
    {
      "Id": null,
      "Name": "Username",
      "Label": "Username",
      "HelpText": "Rackspace control panel username",
      "DefaultValue": "",
      "DisplaySettings": {}
    },
    {
      "Id": null,
      "Name": "ApiKey",
      "Label": "API key",
      "HelpText": "Rackspace control panel user API key",
      "DefaultValue": "",
      "DisplaySettings": {}
    },
    {
      "Id": null,
      "Name": "LoadBalancerID",
      "Label": "Load Balancer ID",
      "HelpText": "ID of the load balancer, found on the details page in the Rackspace control panel",
      "DefaultValue": "",
      "DisplaySettings": {}
    },
    {
      "Id": null,
      "Name": "NodeIpAddress",
      "Label": "Node IP address",
      "HelpText": "IP address of load balanced node. Found on the load balancer details page of the Rackspace control panel",
      "DefaultValue": "",
      "DisplaySettings": {}
    },
    {
      "Id": null,
      "Name": "NewCondition",
      "Label": "New Node Condition",
      "HelpText": "Condition to set the node to. Can either be 'ENABLED', 'DISABLED' or 'DRAINING'",
      "DefaultValue": "",
      "DisplaySettings": {}
    }
  ],
  "LogoAttachmentKey": "CommunityActionTemplates-157-2018011412241565",
  "LogoAttachmentMimeType": "image/png"
}